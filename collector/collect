#!/bin/bash

ROOTDIR="${COLLECTIONS_ROOT}"

TS=$(date +%Y%m%d%H%M%S)
YEAR=${TS:0:4}
MONTH=${TS:4:2}
DAY=${TS:6:2}
TIME=${TS:8:6}

LDIR="${YEAR}/${YEAR}-${MONTH}/${YEAR}-${MONTH}-${DAY}"
PREFIX="${LDIR}/${YEAR}${MONTH}${DAY}-${TIME}"

idx=1
find . -mindepth 1 -maxdepth 1 -type f | sort -u | while read -r FPATH ; do
	FNAME="$(basename "${FPATH}")"
	EXT="${FNAME##*.}"
	if [[ "${EXT}" = "${FNAME}" ]]; then
		EXT=""
	else
		EXT=".${EXT}"
	fi

	while [ -e "${ROOTDIR}/${PREFIX}-${idx}"* ]; do
		idx=$((idx+1))
	done

	if ! collect-file -d "${ROOTDIR}" -f "${FNAME}" -l "${PREFIX}-${idx}${EXT}"; then
		continue
	fi

	idx=$((idx+1))
done
