#!/bin/bash

ROOTDIR="${COLLECTIONS_ROOT}"
FPATH=""
LPATH=""
QUIET=no
STRICT=no

while getopts d:f:l:qs OPT; do
	case ${OPT} in
		d) ROOTDIR="${OPTARG}";;
		f) FPATH="${OPTARG}";;
		l) LPATH="${OPTARG}";;
		q) QUIET=yes;;
		s) STRICT=yes;;
		*) exit 1;;
	esac
done

if [[ "x${ROOTDIR}" = "x" ]]; then
	echo "No root directory (-d) was specified." 1>&2
	exit 2
fi

if [[ "x${FPATH}" = "x" ]]; then
	echo "No file path (-f) was specified." 1>&2
	exit 3
fi

if [ ! -f "${FPATH}" ]; then
	echo "${FPATH} is not a file." 1>&2
	exit 4
fi

if [[ "${LPATH:0:1}" = "/" ]]; then
	echo "A link path (-l) must be a relative path." 1>&2
	exit 5
fi

OBJROOT="${ROOTDIR}/.objects"

if [[ "${QUIET}" = "no" ]]; then
	echo "Adding ${FPATH}"
fi

HASH="$(sha256sum -b "${FPATH}")"
HASH="$(echo "${HASH:0:64}" | tr '[:upper:]' '[:lower:]')"
HASH1="${HASH:0:2}"
HASH2="${HASH:2:3}"
HASH3="${HASH:5:27}"
HASH4="${HASH:32:32}"

OBJDIR="${HASH1}/${HASH2}/${HASH3}"
OBJPATH="${OBJDIR}/${HASH4}"

DUPLICATED=no
if [ -e "${OBJROOT}/${OBJPATH}" ]; then
	DUPLICATED=yes
fi

if [ "${STRICT}" = "yes" ] && [ "${DUPLICATED}" = "yes" ]; then
	echo "${FPATH} already exists." 1>&2
	exit 6
fi

if [[ "${DUPLICATED}" = "no" ]]; then
	if ! mkdir -p "${OBJROOT}/${OBJDIR}"; then
		echo "Failed to create a directory to store the file." 1>&2
		exit 7
	fi

	if ! cp -L "${FPATH}" "${OBJROOT}/${OBJPATH}"; then
		echo "Failed to copy." 1>&2
		exit 8
	fi

	collect-info "${OBJROOT}/${OBJPATH}" > "${OBJROOT}/${OBJPATH}.info"
fi

if [[ "x${LPATH}" != "x" ]]; then
	LDIR="$(dirname "${LPATH}")"
	mkdir -p "${ROOTDIR}/${LDIR}"

	RELPATH=".objects/${OBJPATH}"
	while [[ "${LDIR}" != "." ]]; do
		RELPATH="../${RELPATH}"
		LDIR="$(dirname "${LDIR}")"
	done

	ln -s "${RELPATH}" "${ROOTDIR}/${LPATH}"
fi
