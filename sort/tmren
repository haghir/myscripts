#!/bin/bash

directory="$(pwd)"
dryrun=no

while getopts d:n OPT; do
    case ${OPT} in
        d) directory="${OPTARG}";;
        n) dryrun=yes;;
        *) exit 1;;
    esac
done

# Check if the provided path is a directory
if [[ ! -d "$directory" ]]; then
    echo "Error: '$directory' is not a directory"
    exit 1
fi

# Ask for confirmation
if [[ "$dryrun" == "no" ]]; then
    echo "WARNING: This will rename all files in '$directory' to include timestamps."
    echo "Type YES (in uppercase) to continue:"
    read -r confirmation

    if [[ "$confirmation" != "YES" ]]; then
        echo "Operation cancelled."
        exit 1
    fi
fi

function getts()
{
    TS="$(stat --format="%y" "${1}" 2>/dev/null)"
    if [[ $? -ne 0 ]]; then
        TS="$(stat -f "%Sm" -t "%Y-%m-%d %H:%M:%S.000000" "${1}" 2>/dev/null)"
        if [[ $? -ne 0 ]]; then
            return 1
        fi
    fi

    # 2025-06-04 23:28:47.051574355 +0900
    # 0    5  8  11 14 17 20
    YEAR=${TS:0:4}
    MON=${TS:5:2}
    DAY=${TS:8:2}
    HOUR=${TS:11:2}
    MIN=${TS:14:2}
    SEC=${TS:17:2}
    MIC=${TS:20:6}
    echo "${YEAR}${MON}${DAY}-${HOUR}${MIN}${SEC}-${MIC}"
}

# Process each file in the directory
find "$directory" -type f -print0 | while IFS= read -r -d '' fpath; do
    fname="$(basename "$fpath")"
    dpath="$(dirname "$fpath")"

    # Get the modification timestamp
    timestamp="$(getts "${fpath}")"
    if [[ $? -ne 0 ]]; then
        echo "Failed to get a timestamp for ${fpath}" 1>&2
        continue
    fi

    # Get the file extension
    extension="${fname##*.}"
    if [[ "$extension" == "$fname" ]]; then
        extension=""
    else
        extension=".${extension}"
    fi

    # Create new filename with timestamp
    ((i=0))
    while true; do
        new_name="${dpath}/${timestamp}-${i}${extension}"
        if [[ ! -f "$new_name" ]]; then
            break
        fi
        ((i++))
    done

    # Rename the file
    if [[ "$dryrun" == "no" ]]; then
        mv "$fpath" "$new_name"
        echo "Renamed: $fpath -> $(basename "${new_name}")"
    else
        echo "Would rename: $fpath -> $(basename "${new_name}")"
    fi
done
